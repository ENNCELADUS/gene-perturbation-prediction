# Virtual Cell Challenge Dataset Overview

## About the Virtual Cell Challenge Dataset

The **Virtual Cell Challenge Dataset** is a comprehensive resource designed to advance the modeling of cellular responses to genetic perturbations. It comprises approximately **300,000 single-cell RNA sequencing (scRNA-seq) profiles** derived from **H1 human embryonic stem cells (H1 hESCs)**. These profiles were generated by silencing 300 carefully selected genes using **CRISPR interference (CRISPRi)** technology.

### Dataset Composition

| Set | Description | Genes | Approximate Cells |
|-----|-------------|-------|-------------------|
| **Training** | Model development and fitting | 150 genes | ~150,000 cells |
| **Validation** | Interim evaluation and leaderboard | 50 genes | Varies per gene |
| **Test** | Final performance assessment | 100 genes | Released at final phase |

### Data Generation Details

- **Platform:** 10x Genomics GEM-X Flex + Illumina sequencing
- **Sequencing Depth:** ~50,000 unique molecular identifiers (UMIs) per cell
- **Cell Coverage:** ~1,000 cells per perturbation (median)
- **Format:** AnnData H5AD for seamless integration with analytical tools
- **Source:** [Virtual Cell Challenge](https://virtualcellchallenge.org/datasets)

---

## VCC Raw Data Overview

This page provides a comprehensive introduction to the raw data files used in this project. For project context, see `docs/project-intro/introduction.md`.

---

## File Formats & Access

Competitors can download the training and validation datasets upon registration and login to the Virtual Cell Challenge application. The final test dataset becomes available in the final week of the Challenge.

### Available Datasets

| Dataset | File | Size | Dimensions | Content | Status |
|---------|------|------|------------|---------|--------|
| **Training** | `adata_Training.h5ad` | 15 GB | 221,273 cells × 18,080 genes | Gene expression for 150 target genes (+ controls) | Available upon registration |
| **Validation** | `pert_counts_Validation.csv` | 1 KB | 50 rows | Summary statistics for 50 validation genes | Available upon registration |
| **Test** | `pert_counts_Test.csv` | 1.9 KB | 100 rows | Summary statistics for 100 test genes | Released Nov 10, 2025 |

All files are provided in standardized formats: **AnnData H5AD** for gene expression matrices and **CSV** for summary statistics.

---

## Data Files Location

All raw data is stored in `data/raw/`:

| File | Type | Purpose |
|------|------|---------|
| `adata_Training.h5ad` | AnnData H5AD | Single-cell expression matrix with cell/gene metadata |
| `gene_names.csv` | CSV | Ordered list of 18,079 gene symbols |
| `pert_counts_Validation.csv` | CSV | Validation set statistics: cell counts and sequencing depth |

---

## Training Expression Matrix: `adata_Training.h5ad`

### Overview

**File:** `adata_Training.h5ad` | **Size:** 15 GB | **Format:** Gene Expression File in AnnData H5AD format

The main training dataset containing single-cell RNA-seq profiles of H1 human embryonic stem cells (hESCs) under CRISPR gene perturbations. This dataset comprises gene expression data for **150 target genes** plus control cells (non-targeting CRISPR guides).

### Dimensions and Format

| Property | Value |
|----------|-------|
| Cells (observations) | 221,273 |
| Genes (variables) | 18,080 |
| Expression matrix type | Sparse CSR matrix (`scipy.sparse.csr_matrix`) |
| Data type | float32 |
| Sparsity | ~51.69% zeros |
| File size | ~7.2 GB (compressed) |

### Annotations (Observations - Cells)

Each cell contains three key metadata fields:

| Field | Description | Values |
|-------|-------------|--------|
| `target_gene` | Gene targeted by CRISPR knockout | 151 unique (150 perturbed + 1 non-targeting control) |
| `guide_id` | Specific paired guide RNA identifier | 189 unique combinations |
| `batch` | Experimental batch identifier | 48 unique batches |

**Cell Distribution:**
- Control (non-targeting): ~38,176 cells (~17%)
- Perturbed (specific targets): ~183,097 cells (~83%)
- Average cells per batch: ~4,610

**Control Cells:** There are **38,176 unperturbed control cells** in the training data denoted with a `target_gene` value of `'non-targeting'`. These represent baseline gene expression for unperturbed H1 hESCs. Competitors can optionally predict expression values for the control set during submission or copy expression values over from the training set.

### Annotations (Variables - Genes)

Each gene entry contains:

| Field | Description |
|-------|-------------|
| `gene_id` | Ensembl gene identifier (e.g., `ENSG00000187634`) |
| Gene index (row name) | Gene symbol (e.g., `SAMD11`, `TP53`) |

Coverage includes protein-coding genes and mitochondrial genes (MT-encoded).

### Expression Values

The expression matrix `X` contains read counts or normalized expression values:

- **Min value:** 1.0
- **Max value:** 392.0
- **Mean:** 6.5
- **Median:** 3.0
- **Non-zero elements:** ~1.93 billion (48.31% of total possible values)

### Loading and Exploring

```python
import anndata as ad

# Load the file
adata = ad.read_h5ad("data/raw/adata_Training.h5ad")

# View structure
print(adata)
print(adata.shape)
print(adata.X.dtype)

# Inspect metadata
print(adata.obs.head())
print(adata.var.head())

# Access expression for specific cells/genes
subset = adata[:100, :50]
```

---

## Gene Names Reference: `gene_names.csv`

### Overview

A simple CSV file containing an ordered list of gene symbols matching the gene dimension of the training matrix.

### Specifications

| Property | Value |
|----------|-------|
| Format | CSV (single column, no header) |
| Number of entries | 18,079 genes |
| Gene type | Ensembl-indexed human gene symbols |
| Order | Consistent with `adata.var` index (except first gene) |

### Gene Listing

- **Early genes:** SAMD11, NOC2L, KLHL17, PERM1, HES4, ISG15, AGRN
- **Mitochondrial genes:** MT-ND2, MT-CO2, MT-ATP6, MT-CO3, MT-ND3, MT-ND4L, MT-ND4, MT-ND5, MT-ND6, MT-CYB

### Usage

```python
import pandas as pd

# Load gene names
gene_names = pd.read_csv("data/raw/gene_names.csv", header=None).squeeze().tolist()

print(f"Total genes: {len(gene_names)}")
print(f"First genes: {gene_names[:5]}")
print(f"Last genes: {gene_names[-5:]}")

# Use for indexing
important_genes = ["TP53", "BRCA1", "CDKN1A"]
gene_indices = [gene_names.index(g) for g in important_genes if g in gene_names]
```

### Important Notes

- **Count mismatch:** 18,079 genes in CSV vs. 18,080 in the h5ad matrix. Verify alignment when combining files.
- **All entries are unique** — no duplicate gene symbols.

---

## Validation Perturbation Summary: `pert_counts_Validation.csv`

### Overview

**File:** `pert_counts_Validation.csv` | **Size:** 1 KB | **Format:** CSV | **Rows:** 50

Summary statistics for the 50 genes in the validation set, including cell counts and RNA sequencing depth (UMI - Unique Molecular Identifiers). This file provides essential metadata for the **50 validation target genes**, used for interim evaluation and leaderboard rankings during the challenge.

### Specifications

| Property | Value |
|----------|-------|
| Format | CSV |
| Number of genes | 50 (validation target set) |
| Columns | `target_gene`, `n_cells`, `median_umi_per_cell` |

### Column Descriptions

| Field | Description |
|-------|-------------|
| `target_gene` | Gene symbol targeted for perturbation |
| `n_cells` | Recommended number of cells to predict for each perturbation to maximize model performance |
| `median_umi_per_cell` | The median number of Unique Molecular Identifiers per cell for each perturbation |

### Statistics Summary

| Metric | n_cells | median_umi_per_cell |
|--------|---------|---------------------|
| Minimum | 161 | 38,650 |
| 25th percentile | 685 | 53,221 |
| Median | 1,091 | 54,447 |
| Mean | 1,215 | 54,082 |
| 75th percentile | 1,634 | 55,351 |
| Maximum | 2,925 | 63,176 |

**Key Observation:** Median UMI values are stable (~54k) across all genes, indicating consistent sequencing quality across the validation set.

### Recommended Usage

The `n_cells` column provides the **recommended number of cells to predict** for each perturbation to maximize model performance. Use this guidance when evaluating and submitting validation predictions.

### Top and Bottom Perturbations (by cell count)

**Top 5:**

| Target Gene | Cell Count | Median UMI/Cell |
|-------------|------------|-----------------|
| SH3BP4 | 2,925 | 54,551 |
| ZNF581 | 2,502 | 53,804 |
| ANXA6 | 2,496 | 55,175 |
| PACSIN3 | 2,101 | 54,088 |
| MGST1 | 2,096 | 54,218 |

**Bottom 5:**

| Target Gene | Cell Count | Median UMI/Cell |
|-------------|------------|-----------------|
| EIF3H | 323 | 53,504 |
| FUBP1 | 288 | 55,334 |
| WAC | 267 | 60,363 |
| ZNF598 | 255 | 54,046 |
| MAX | 161 | 38,650 |

### Usage Example

```python
import pandas as pd

# Load validation data
df_val = pd.read_csv("data/raw/pert_counts_Validation.csv")

# Sort by cell count (descending)
print(df_val.sort_values("n_cells", ascending=False).head(10))

# Filter for high-coverage genes
high_coverage = df_val[df_val["n_cells"] >= 1500]
print(f"High-coverage genes ({1500}+ cells): {len(high_coverage)}")

# Summary statistics
print(df_val.describe())
```

---

## Test Perturbation Summary: `pert_counts_Test.csv`

### Overview

**File:** `pert_counts_Test.csv` | **Size:** 1.9 KB | **Format:** CSV | **Rows:** 100 | **Release Date:** November 10, 2025

Summary statistics for the **100 genes in the test set**, released in the final week of the challenge for final model evaluation. Like the validation set, this file contains cell counts and sequencing depth recommendations for each test perturbation.

### Format

The test file follows the same structure as the validation file:

| Field | Description |
|-------|-------------|
| `target_gene` | Gene symbol targeted for perturbation |
| `n_cells` | Recommended number of cells to predict for each perturbation to maximize model performance |
| `median_umi_per_cell` | The median number of Unique Molecular Identifiers per cell for each perturbation |

### Purpose

The test set is used to perform **final performance assessment** of models trained on the 150 training genes. Competitors should predict expression responses for all 100 test perturbations and submit their predictions for leaderboard ranking.

---

## Target Gene Selection

### Selection Methodology

The target genes for the Virtual Cell Challenge were carefully selected through a rigorous methodology to ensure broad experimental coverage and diverse biological effects:

#### 1. Initial Screening

Perturbation methods were applied to approximately **2,500 genes** to characterize their downstream transcriptomic effects. This broad screen identified genes based on the strength of their perturbation effects (measured by the number of significantly differentially expressed genes, DEGs).

#### 2. Effect Size Classification

Genes were classified into three categories based on their perturbation strength:

| Category | Effect Size | % of Candidates | Count | Description |
|----------|------------|-----------------|-------|-------------|
| **Strong** | >100 DEGs | 35% | 935 genes | Substantial transcriptomic changes |
| **Subtle** | 10-100 DEGs | 29% | 754 genes | Moderate transcriptomic changes |
| **Negligible** | <10 DEGs | 46% | 1,316 genes | Minimal or no transcriptomic effect |

#### 3. Final Selection Criteria

From the effect size-classified pool, final target genes were selected based on:

- **Phenotypic Diversity:** Genes showing diverse downstream effects based on Gene Ontology annotations and initial screen results
- **Cross-species Representation:** Genes previously perturbed in other cell types across publicly available datasets
- **Generalization Testing:** Ensures models can test their ability to generalize from other cell types to H1 hESCs

#### 4. Final Breakdown

- **Training Set:** 150 target genes (from the strong, subtle, and negligible categories)
- **Validation Set:** 50 target genes
- **Test Set:** 100 target genes
- **Total:** 300 carefully selected perturbations

### Data Sources

The original perturbation data used for initial screening and classification was obtained from in-house broad, low-depth screens in H1 hESCs. These data are not part of the Virtual Cell Challenge and are not publicly available. The public Virtual Cell Challenge dataset contains only the high-depth, high-coverage sequencing data for the selected target genes.

---

## AnnData Structure Reference

The H5AD file structure at a glance:

```
adata (AnnData object)
├── X: Sparse CSR matrix (221,273 cells × 18,080 genes)
│   └── dtype: float32, ~51.69% zeros
├── obs: Cell-level metadata (221,273 rows)
│   ├── target_gene (category: 151 unique)
│   ├── guide_id (category: 189 unique)
│   └── batch (category: 48 unique)
├── var: Gene-level metadata (18,080 rows)
│   └── gene_id (Ensembl identifiers)
├── uns: Unstructured metadata (empty)
├── obsm: Multi-dimensional cell annotations (empty)
├── varm: Multi-dimensional gene annotations (empty)
├── obsp: Pairwise cell relationships (empty)
└── varp: Pairwise gene relationships (empty)
```

---

## Visual Overview

### H5AD Structure

![H5AD Overview](visualizations/h5ad_visualization.png)

### Expression Matrix Details

![Expression Details](visualizations/h5ad_expression_details.png)

---

## Integration with the Project

### How This Data Fits

- **Goal:** Learn from 150 training genes to predict transcriptomic responses for 50 validation and 100 test genes (see `docs/project-intro/introduction.md`).
- **Training Input:** Use `adata_Training.h5ad` for model fitting and validation on unseen perturbations.
- **Supporting Files:** 
  - Use `gene_names.csv` for consistent gene indexing across utilities.
  - Use `pert_counts_Validation.csv` to understand validation coverage and prioritize data quality.

### Quick-Start Scripts

Located in `scripts/`:

| Script | Purpose |
|--------|---------|
| `visualize_h5ad.py` | Interactive exploration: inspect dims, view distributions, plot PCA/UMAP |
| `preview_data.py` | Fast data checks: display CSV shapes, sample rows, basic stats |

---

## Key Insights

1. **Large-scale, well-controlled dataset:** 221k cells with ~17% untouched controls for baseline comparison.
2. **Multi-batch experimental design:** 48 batches mitigate single-batch biases.
3. **Efficient storage:** Sparse format saves ~52% memory; suitable for large-scale model training.
4. **Consistent quality:** Median UMI across validation set is stable (~54k), confirming reliable sequencing.
5. **Full transcriptome coverage:** All protein-coding genes plus mitochondrial genes included.
6. **Sparse expression pattern:** ~52% zeros reflect biological sparsity in single-cell RNA-seq (many genes have zero or low counts per cell).
7. **Carefully curated gene selection:** 300 target genes selected based on effect size diversity and cross-species representation.
