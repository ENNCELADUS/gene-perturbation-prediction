# scGPT Retrieval Configuration for Reverse Perturbation Prediction

# Data
data:
  h5ad_path: data/norman/perturb_processed.h5ad

# Norman GEARS-style Condition-level split (optimized)
condition_split:
  unseen_gene_fraction: 0.15      # 15% of single-genes → test-only (~12-15 genes, increased train coverage)
  seen_single_train_ratio: 0.9    # 90% train / 10% val for seen singles
  combo_seen2_train_ratio: 0.7    # 70% train for 2/2-seen combos
  combo_seen2_val_ratio: 0.15     # 15% val for 2/2-seen combos (remaining → test)
  min_cells_per_condition: 50     # Filter threshold for single-gene conditions
  min_cells_per_double: 30        # Lower threshold for double-gene (increase coverage, handle noise)
  seed: 42
  output_path: data/norman/splits/norman_condition_split_optimized_seed42.json

# Model
model:
  encoder: scgpt
  checkpoint: null  # Path to scGPT pretrained weights
  finetune_checkpoint: null  # Path to fine-tuned retrieval checkpoint
  finetune_apply_head: true
  freeze_encoder: true
  use_lora: false
  lora_rank: 8
  gene_alias_map_path: null
  # Preprocessing: Plan A - Use log-normalized + HVG filtered data from adata.X
  # Only binning is needed for scGPT value encoder
  preprocess: true
  preprocess_binning: 51
  preprocess_result_binned_key: X_binned

# Prototype library
library:
  type: bootstrap  # bootstrap | mean | raw_cell
  n_prototypes: 30
  m_cells_per_prototype: 50
  seed: 42

# Retrieval
retrieval:
  metric: cosine  # cosine | euclidean
  top_k: [1, 5, 8, 10]

# Query setup
query:
  mode: cell  # cell | pseudobulk
  query_split: test  # train | val | test
  candidate_source: all  # all | train | train_val
  pseudo_bulk:
    cells_per_bulk: 50
    n_bulks: 1
    seed: 42
  pseudo_bulk_curve:
    enable: false
    cells_per_bulk_values: [10, 25, 50, 100, 200]
    n_bulks: 5
    seed: 42

# Evaluation
evaluate:
  mask_perturbed: true  # Anti-cheat: mask perturbed gene expression
  mask_ablation: true

# Confidence estimation
confidence:
  enable: true
  method: margin  # margin | entropy
  coverage_points: 20
  top_k_agreement: 1

# Reporting
report:
  enable: false
  result_dirs: []
  output_dir: results/reports
  report_name: comparison_report

# Logging
logging:
  output_dir: results/
  experiment_name: scgpt
